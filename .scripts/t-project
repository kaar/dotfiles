#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail

ROOT_DIR="$HOME/repos/kaar"

usage() {
  cat <<EOF
Usage: $(basename "$0") [options] [project-name]

Manage project-specific tmux sessions in ~/repos/kaar/
Each project is a git repository with its own dedicated tmux session.

Commands:
  $(basename "$0")                 Interactive project selection using fzf
  $(basename "$0") <project-name>  Switch to existing project (errors if not found)
  $(basename "$0") -n <name>       Create new project and switch to it
  $(basename "$0") -l              List all projects
  $(basename "$0") -h              Show this help message

Options:
  -n, --new <name>    Create new project with git repo and optional GitHub repo
  -l, --list          List all projects in ~/repos/kaar
  -h, --help          Show this help message

Behavior:
  - Switching: Creates tmux session if needed, then attaches/switches
  - Creating: Initializes git repo with formatted README.md title
              Prompts to create private GitHub repository
  - When inside tmux: Switches to the project session
  - When outside tmux: Attaches to the project session

Examples:
  $(basename "$0")              # Select from existing projects interactively
  $(basename "$0") my-app       # Switch to 'my-app' (must already exist)
  $(basename "$0") -n my-app    # Create new project 'my-app'
  $(basename "$0") -l           # List all projects
EOF
}

project_exists() {
  local project_name=$1
  local project_dir=~/repos/kaar/"$project_name"
  [[ -d "$project_dir" ]]
}

format_project_title() {
  local name=$1

  # Replace hyphens and underscores with spaces
  name="${name//-/ }"
  name="${name//_/ }"

  # Replace dots with spaces (will handle version numbers like 2.1 later)
  name="${name//./ }"

  # Insert space before uppercase letters that follow lowercase (camelCase)
  # shellcheck disable=SC2001
  name=$(echo "$name" | sed 's/\([a-z]\)\([A-Z]\)/\1 \2/g')

  # Insert space before numbers that follow letters
  # shellcheck disable=SC2001
  name=$(echo "$name" | sed 's/\([a-zA-Z]\)\([0-9]\)/\1 \2/g')

  # Capitalize first letter of each word
  local result=""
  for word in $name; do
    result="$result ${word^}"
  done

  echo "${result# }"
}

create_project() {
  local project_name=$1
  local project_dir=~/repos/kaar/"$project_name"
  if [ -d "$project_dir" ]; then
    echo "Project directory $project_dir already exists."
    exit 1
  fi

  echo "Creating project directory $project_dir"
  mkdir -p "$project_dir"
  cd "$project_dir" || exit 1
  git init

  local project_title
  project_title=$(format_project_title "$project_name")
  echo "# $project_title" >README.md

  git add README.md
  git commit -m "Initial commit"
  # Ask if to create a GitHub repository.
  read -r -p "Create a private GitHub repository for $project_name? (y/n) " response
  if [[ ! "$response" =~ ^[Yy]$ ]]; then
    return
  fi
  echo "Creating GitHub repository kaar/$project_name"
  gh repo create kaar/"$project_name" --private --source=. --remote=origin --push
  echo "Project $project_name created at $project_dir and pushed to GitHub."
}

list_projects() {
  find "$ROOT_DIR" -maxdepth 1 -mindepth 1 -type d -exec basename {} \;
}

switch_to_project() {
  local project_name=$1
  local project_dir="$ROOT_DIR/$project_name"

  echo "Switching to project directory $project_dir"

  # Check if tmux session exists, create it if it doesn't
  local session_name="$project_name"
  if ! tmux has-session -t "$session_name" 2>/dev/null; then
    tmux new-session -ds "$session_name" -c "$project_dir"
  fi

  # Attach or switch tmux session
  if [ -z "${TMUX-}" ]; then
    tmux attach-session -t "$session_name"
  else
    tmux switch-client -t "$session_name"
  fi
}

case "${1:-}" in
-h | --help)
  usage
  exit 0
  ;;
-l | --list)
  list_projects
  exit 0
  ;;
-n | --new)
  if [[ -z "${2:-}" ]]; then
    echo "Error: Project name required for -n/--new flag"
    echo "Usage: $(basename "$0") -n <project-name>"
    exit 1
  fi
  project_name="${2}"
  if project_exists "$project_name"; then
    echo "Error: Project '$project_name' already exists"
    exit 1
  fi
  create_project "$project_name"
  switch_to_project "$project_name"
  exit 0
  ;;
esac

# If no project name is given, select from existing projects using fzf.
if [[ -z "${1:-}" ]]; then
  project_name=$(list_projects | fzf --reverse \
    --header "Select project" \
    --preview "ls -la $ROOT_DIR/{}")

  if [[ -z "$project_name" ]]; then
    echo "No project selected."
    exit 1
  fi
else
  project_name="${1}"
fi

# Switch to existing project only
if ! project_exists "$project_name"; then
  echo "Error: Project '$project_name' does not exist"
  echo "Create it with: $(basename "$0") -n $project_name"
  exit 1
fi

switch_to_project "$project_name"
