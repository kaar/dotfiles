#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail

ROOT_DIR="$HOME/repos/kaar"

[[ -d "$ROOT_DIR" ]] || {
  echo "Error: Root directory $ROOT_DIR does not exist."
  exit 1
}

usage() {
  cat <<EOF
Usage: $(basename "$0") [command] [arguments]

Manage project-specific tmux sessions in ~/repos/kaar/
Each project is a git repository with its own dedicated tmux session.

Commands:
  $(basename "$0") co                Interactive project selection using fzf
  $(basename "$0") co <name>         Switch to existing project (errors if not found)
  $(basename "$0") new <name>        Create new project and switch to it
  $(basename "$0") ls                List all projects
  $(basename "$0") help, -h, --help  Show this help message

Behavior:
  - Switching: Creates tmux session if needed, then attaches/switches
  - Creating: Initializes git repo with formatted README.md title
              Prompts to create private GitHub repository
  - When inside tmux: Switches to the project session
  - When outside tmux: Attaches to the project session

Examples:
  $(basename "$0")              # Select and open project interactively with fzf
  $(basename "$0") co my-app    # Switch to 'my-app' (must already exist)
  $(basename "$0") new my-app   # Create new project 'my-app'
  $(basename "$0") ls           # List all projects
EOF
}

project_exists() {
  local project_name=$1
  [[ -d "$ROOT_DIR/$project_name" ]]
}

format_project_title() {
  local name=$1

  # Replace hyphens and underscores with spaces
  name="${name//-/ }"
  name="${name//_/ }"

  # Replace dots with spaces (will handle version numbers like 2.1 later)
  name="${name//./ }"

  # Insert space before uppercase letters (camelCase) and before numbers
  # shellcheck disable=SC2001
  name=$(echo "$name" | sed 's/\([a-z]\)\([A-Z]\)/\1 \2/g; s/\([a-zA-Z]\)\([0-9]\)/\1 \2/g')

  # Capitalize first letter of each word
  local result=""
  for word in $name; do
    result="$result ${word^}"
  done

  echo "${result# }"
}

create_project() {
  local project_name=$1
  local project_dir="$ROOT_DIR/$project_name"



  echo "Creating project directory $project_dir"
  mkdir -p "$project_dir"
  cd "$project_dir" || exit 1
  git init

  local project_title
  project_title=$(format_project_title "$project_name")
  echo "# $project_title" >README.md

  git add README.md
  git commit -m "Initial commit"
  # Ask if to create a GitHub repository.
  read -r -p "Create a private GitHub repository for $project_name? (y/n) " response
  if [[ ! "$response" =~ ^[Yy]$ ]]; then
    return
  fi
  echo "Creating GitHub repository kaar/$project_name"
  gh repo create kaar/"$project_name" --private --source=. --remote=origin --push
  echo "Project $project_name created at $project_dir and pushed to GitHub."
}

list_projects() {
  local active_sessions
  mapfile -t active_sessions < <(tmux list-sessions -F '#{session_name}' 2>/dev/null || true)

  # Create associative array for O(1) lookup
  declare -A is_active
  for session in "${active_sessions[@]}"; do
    is_active[$session]=1
  done

  # Process and output (avoiding subshell from pipe)
  while IFS='|' read -r status project; do
    if [[ "$status" == "0" ]]; then
      echo -e "\033[1;32m● $project\033[0m"
    else
      echo -e "\033[2m○ $project\033[0m"
    fi
  done < <(
    while IFS= read -r project; do
      if [[ -n "${is_active[$project]:-}" ]]; then
        echo "0|$project"
      else
        echo "1|$project"
      fi
    done < <(find "$ROOT_DIR" -maxdepth 1 -mindepth 1 -type d -printf '%f\n') | sort -t'|' -k1
  )
}

open_project() {
  local project_name=$1
  local project_dir="$ROOT_DIR/$project_name"
  local session_name="$project_name"

  # Check if tmux session exists, create it if it doesn't
  if ! tmux has-session -t "$session_name" 2>/dev/null; then
    tmux new-session -ds "$session_name" -c "$project_dir"
  fi

  # Attach or switch tmux session
  if [[ -z "${TMUX-}" ]]; then
    tmux attach-session -t "$session_name"
  else
    tmux switch-client -t "$session_name"
  fi
}

select_project() {
  local query="${1:-}"
  local fzf_opts=(--reverse --ansi --header "Select project")

  # Add query if provided
  [[ -n "$query" ]] && fzf_opts+=(--query "$query")

  local selection
  selection=$(list_projects | fzf "${fzf_opts[@]}" \
    --preview "PROJECT=\$(echo {} | sed 's/^[●○] //'); \
               echo -e '\033[1;34mPath:\033[0m $ROOT_DIR/\$PROJECT'; \
               echo -e '\033[2m───────────────────────────────────────\033[0m'; \
               if tmux has-session -t \$PROJECT 2>/dev/null; then \
                 echo -e '\033[1;32m● Active tmux session\033[0m'; \
               else \
                 echo -e '\033[2m○ No active session\033[0m'; \
               fi; \
               echo -e '\033[2m───────────────────────────────────────\033[0m'; \
               git -C $ROOT_DIR/\$PROJECT log -1 --format='%C(yellow)Last commit:%C(reset) %ar%n%C(yellow)Author:%C(reset) %an' 2>/dev/null || echo -e '\033[2mNo commits yet\033[0m'; \
               echo -e '\033[2m───────────────────────────────────────\033[0m'; \
               ls -1 $ROOT_DIR/\$PROJECT")

  [[ -z "$selection" ]] && return 1
  # Skip (2), indicator + space
  local project="${selection:2}"
  [[ -n "$project" ]] || return 1
  echo "${project}"
}

command="${1:-}"

case "$command" in
help | -h | --help)
  usage
  exit 0
  ;;
ls)
  list_projects
  exit 0
  ;;
new)
  shift
  project_name="${1:-}"
  if [[ -z "$project_name" ]]; then
    echo "Error: Project name required for 'new' command"
    echo "Usage: $(basename "$0") new <project-name>"
    exit 1
  fi
  if [[ "$project_name" =~ [^a-zA-Z0-9._-] ]]; then
    echo "Error: Invalid project name '$project_name'"
    echo "Use only: letters, numbers, dots (.), hyphens (-), underscores (_)"
    exit 1
  fi
  if project_exists "$project_name"; then
    echo "Error: Project '$project_name' already exists"
    exit 1
  fi
  create_project "$project_name"
  open_project "$project_name"
  exit 0
  ;;
co)
  shift
  project_name="${1:-}"

  # If no project name given, use fzf to select
  if [[ -z "$project_name" ]]; then
    if ! project_name=$(select_project); then
      exit 1
    fi
  else
    # If project exists, open it directly; otherwise use fzf with the name as filter
    if ! project_exists "$project_name"; then
      if ! project_name=$(select_project "$project_name"); then
        exit 1
      fi
    fi
  fi

  open_project "$project_name"
  exit 0
  ;;
"")
  # No command given, default to 'co' behavior (fzf selection)
  if ! project_name=$(select_project); then
    exit 1
  fi
  open_project "$project_name"
  exit 0
  ;;
*)
  echo "Error: Unknown command '$command'"
  echo "Run '$(basename "$0") help' for usage information"
  exit 1
  ;;
esac
